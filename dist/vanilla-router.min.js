/**
 * Router@1.2.0
 * author: Graidenix
 */
!function(t){"use strict";function e(e){var r=this._getSettings(e);return this.routes=r.routes,this.notFoundHandler=r.page404,this.mode=t.history&&t.history.pushState?r.mode:"hash",this.root="/"===r.root?"/":"/"+this._trimSlashes(r.root)+"/",this.beforeHook=r.hooks.before,this._pageState=null,this._currentPage=null,this._skipCheck=!1,this._action=null,"hash"===this.mode&&(this._historyStack=[],this._historyIdx=0,this._historyState="add"),this}e.Page=function(t,e,r,o,s){this.uri=t||"",this.query=e||{},this.params=r||[],this.state=o||null,this.options=s||{}},e.prototype._getSettings=function(t){var e={},r={routes:[],mode:"history",root:"/",hooks:{before:function(){}},page404:function(t){console.error({page:t,message:"404. Page not found"})}};return t=t||{},["routes","mode","root","page404","hooks"].forEach(function(o){e[o]=t[o]||r[o]}),e},e.prototype._getHistoryFragment=function(){var e=decodeURI(t.location.pathname);return"/"!==this.root&&(e=e.replace(this.root,"")),this._trimSlashes(e)},e.prototype._getHashFragment=function(){var e=t.location.hash.substr(1).replace(/(\?.*)$/,"");return this._trimSlashes(e)},e.prototype._getFragment=function(){return"history"===this.mode?this._getHistoryFragment():this._getHashFragment()},e.prototype._trimSlashes=function(t){return"string"!=typeof t?"":(""+t).replace(/\/$/,"").replace(/^\//,"")},e.prototype._page404=function(t){this._currentPage=new e.Page(t),this.notFoundHandler(t)},e.prototype._parseRouteRule=function(t){if("string"!=typeof t)return t;var e=this._trimSlashes(t),r=e.replace(/([\\\/\-\_\.])/g,"\\$1").replace(/\{[a-zA-Z]+\}/g,"(:any)").replace(/\:any/g,"[\\w\\-\\_\\.]+").replace(/\:word/g,"[a-zA-Z]+").replace(/\:num/g,"\\d+");return RegExp("^"+r+"$","i")},e.prototype._parseQuery=function(t){var e={};return"string"!=typeof t?e:("?"===t[0]&&(t=t.substr(1)),this._queryString=t,t.split("&").forEach(function(t){var r=t.split("=");""!==r[0]&&(void 0===r[1]&&(r[1]=!0),e[decodeURIComponent(r[0])]=r[1])}),e)},e.prototype._getHistoryQuery=function(){return this._parseQuery(t.location.search)},e.prototype._getHashQuery=function(){var e=t.location.hash.indexOf("?"),r=-1!==e?t.location.hash.substr(e):"";return this._parseQuery(r)},e.prototype._getQuery=function(){return"history"===this.mode?this._getHistoryQuery():this._getHashQuery()},e.prototype.add=function(t,e,r){return this.routes.push({rule:this._parseRouteRule(t),handler:e,options:r}),this},e.prototype.remove=function(t){var e=this;return"string"==typeof t&&(t=""+this._parseRouteRule(t)),this.routes.some(function(r,o){return r.handler===t||""+r.rule===t?(e.routes.splice(o,1),!0):!1}),this},e.prototype.reset=function(){return this.routes=[],this.mode=null,this.root="/",this._pageState={},this.removeUriListener(),this},e.prototype._pushHistory=function(){var t=this,e=this._getFragment();"hash"===this.mode&&("add"===this._historyState&&(this._historyIdx!==this._historyStack.length-1&&this._historyStack.splice(this._historyIdx+1),this._historyStack.push({path:e,state:t._pageState}),this._historyIdx=this._historyStack.length-1),this._historyState="add")},e.prototype._unloadCallback=function(t){var e;return this._currentPage&&this._currentPage.options&&this._currentPage.options.unloadCb?(e=this._currentPage.options.unloadCb(this._currentPage,t),!t||e instanceof Promise?e:e?Promise.resolve(e):Promise.reject(e)):t?Promise.resolve(!0):!0},e.prototype._findRoute=function(){var r=this,o=this._getFragment();return this.routes.some(function(s){var i=o.match(s.rule);if(i){i.shift();var h=r._getQuery(),n=new e.Page(o,h,i,r._pageState,s.options);return r._currentPage=n,r._skipCheck?(r._skipCheck=!1,!0):(r.beforeHook(n),s.handler.apply(n,i),r._pageState=null,t.onbeforeunload=function(t){return r._unloadCallback(!1)?void 0:(t.returnValue=!0,!0)},!0)}return!1})},e.prototype._resetState=function(){this._skipCheck=!0,this.navigateTo(this._current,this._currentPage.state,!0)},e.prototype.check=function(){var t=this,e=this._getFragment();return this._unloadCallback(!0).then(function(){var r;t._current=e,t._pushHistory(),r=t._findRoute.call(t),r||t._page404(e)}).catch(function(){t._resetState()}),this},e.prototype.addUriListener=function(){var e=this;return"history"===e.mode?t.onpopstate=function(){return e.check()}:t.onhashchange=function(){return e.check()},this},e.prototype.removeUriListener=function(){return t.onpopstate=null,t.onhashchange=null,this},e.prototype.navigateTo=function(e,r,o){return e=this._trimSlashes(e)||"",this._pageState=r||null,this._skipCheck=!!o,this._action="navigate","history"===this.mode?(history.pushState(r,null,this.root+this._trimSlashes(e)),this.check()):(t.location.hash=e,this)},e.prototype.refresh=function(){if(this._action="refresh",!this._currentPage)return this;var t=this._currentPage.uri+"?"+this._queryString;return this.navigateTo(t,this._currentPage.state)},e.prototype.back=function(){return this._action="back","history"===this.mode?(t.history.back(),this):this.go(this._historyIdx-1)},e.prototype.forward=function(){return this._action="forward","history"===this.mode?(t.history.forward(),this):this.go(this._historyIdx+1)},e.prototype.go=function(e){if(this._action="go","history"===this.mode)return t.history.go(e),this;var r=this._historyStack[e];return r?(this._historyIdx=e,this._historyState="hold",this.navigateTo(r.path,r.state)):this},t.Router=e}(window);
