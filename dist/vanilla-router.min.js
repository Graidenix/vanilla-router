!function(a){"use strict";function b(b){var c=this._getSettings(b);return this.routes=c.routes,this.notFoundHandler=c.page404,this.mode=a.history&&a.history.pushState?c.mode:"hash",this.root="/"===c.root?"/":"/"+this._trimSlashes(c.root)+"/",this._pageState=null,this.beforeHook=c.hooks.before,this._currentPage=null,this._skipCheck=!1,"hash"===this.mode&&(this._historyStack=[],this._historyIdx=0,this._historyState="add"),this}b.Page=function(a,b,c,d,e){this.uri=a||"",this.query=b||{},this.params=c||[],this.state=d||null,this.options=e||{}},b.prototype._getSettings=function(a){var b={},c={routes:[],mode:"history",root:"/",hooks:{before:function(){}},page404:function(a){console.error({page:a,message:"404. Page not found"})}};return a=a||{},["routes","mode","root","page404","hooks"].forEach(function(d){b[d]=a[d]||c[d]}),b},b.prototype._getHistoryFragment=function(){var b=decodeURI(a.location.pathname);return"/"!==this.root&&(b=b.replace(this.root,"")),this._trimSlashes(b)},b.prototype._getHashFragment=function(){var b=a.location.hash.substr(1).replace(/(\?.*)$/,"");return this._trimSlashes(b)},b.prototype._getFragment=function(){return"history"===this.mode?this._getHistoryFragment():this._getHashFragment()},b.prototype._trimSlashes=function(a){return"string"!=typeof a?"":a.toString().replace(/\/$/,"").replace(/^\//,"")},b.prototype._page404=function(a){this.notFoundHandler(a)},b.prototype._parseRouteRule=function(a){if("string"!=typeof a)return a;var b=this._trimSlashes(a),c=b.replace(/([\\\/\-\_\.])/g,"\\$1").replace(/\{[a-zA-Z]+\}/g,"(:any)").replace(/\:any/g,"[\\w\\-\\_\\.]+").replace(/\:word/g,"[a-zA-Z]+").replace(/\:num/g,"d+");return new RegExp("^"+c+"$","i")},b.prototype._parseQuery=function(a){var b={};return"string"!=typeof a?b:("?"===a[0]&&(a=a.substr(1)),a.split("&").forEach(function(a){var c=a.split("=");""!==c[0]&&(void 0===c[1]&&(c[1]=!0),b[decodeURIComponent(c[0])]=c[1])}),b)},b.prototype._getHistoryQuery=function(){return this._parseQuery(a.location.search)},b.prototype._getHashQuery=function(){var b=a.location.hash.indexOf("?"),c=-1!==b?a.location.hash.substr(b):"";return this._parseQuery(c)},b.prototype._getQuery=function(){return"history"===this.mode?this._getHistoryQuery():this._getHashQuery()},b.prototype.add=function(a,b,c){return this.routes.push({rule:this._parseRouteRule(a),handler:b,options:c}),this},b.prototype.remove=function(a){var b=this;return"string"==typeof a&&(a=this._parseRouteRule(a).toString()),this.routes.some(function(c,d){return c.handler===a||c.rule.toString()===a?(b.routes.splice(d,1),!0):!1}),this},b.prototype.reset=function(){return this.routes=[],this.mode=null,this.root="/",this._pageState={},this.removeUriListener(),this},b.prototype._pushHistory=function(){var a=this,b=this._getFragment();"hash"===this.mode&&("add"===this._historyState&&(this._historyIdx!==this._historyStack.length-1&&this._historyStack.splice(this._historyIdx+1),this._historyStack.push({path:b,state:a._pageState}),this._historyIdx=this._historyStack.length-1),this._historyState="add")},b.prototype._unloadCallback=function(){return this._currentPage&&this._currentPage.options&&this._currentPage.options.unloadCb?this._currentPage.options.unloadCb(this._currentPage):!0},b.prototype.check=function(){var c=this,d=this._getFragment();if(this._skipCheck)return void(this._skipCheck=!1);if(!this._unloadCallback())return this._skipCheck=!0,"history"===this.mode?a.history.back():a.location.hash=this._current,this;c._current=d,this._pushHistory();var e=this.routes.some(function(e){var f=d.match(e.rule);if(f){f.shift();var g=c._getQuery(),h=new b.Page(d,g,f,c._pageState,e.options);return c.beforeHook(h),c._currentPage=h,e.handler.apply(h,f),c._pageState=null,a.onbeforeunload=function(){return c._unloadCallback()?void 0:"text"},!0}return!1});return e||this._page404(d),this},b.prototype.addUriListener=function(){var b=this;return"history"===b.mode?a.onpopstate=function(){return b.check()}:a.onhashchange=function(){return b.check()},this},b.prototype.removeUriListener=function(){return a.onpopstate=null,a.onhashchange=null,this},b.prototype.navigateTo=function(b,c){return b=this._trimSlashes(b)||"",this._pageState=c||null,"history"===this.mode?(history.pushState(c,null,this.root+this._trimSlashes(b)),this.check()):(a.location.hash=b,this)},b.prototype.back=function(){return"history"===this.mode?(a.history.back(),this):this.go(this._historyIdx-1)},b.prototype.forward=function(){return"history"===this.mode?(a.history.forward(),this):this.go(this._historyIdx+1)},b.prototype.go=function(b){if("history"===this.mode)return a.history.go(b),this;var c=this._historyStack[b];return c?(this._historyIdx=b,this._historyState="hold",this.navigateTo(c.path,c.state)):this},a.Router=b}(window);
