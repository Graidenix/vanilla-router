!function(a){"use strict";function b(b){var c=this._getSettings(b);return this.routes=c.routes,this.notFoundHandler=c.page404,this.mode=a.history&&a.history.pushState?c.mode:"hash",this.root="/"===c.root?"/":"/"+this._trimSlashes(c.root)+"/",this._pageState=null,"hash"===this.mode&&(this._historyStack=[],this._historyIdx=0,this._historyState="add"),this}b.Page=function(a,b,c,d){this.uri=a||"",this.query=b||{},this.params=c||[],this.state=d||null},b.prototype._getSettings=function(a){var b={},c={routes:[],mode:"history",root:"/",page404:function(a){console.error({page:a,message:"404. Page not found"})}};return a=a||{},["routes","mode","root","page404"].forEach(function(d){b[d]=a[d]||c[d]}),b},b.prototype._getHistoryFragment=function(){var b=decodeURI(a.location.pathname);return"/"!==this.root&&(b=b.replace(this.root,"")),this._trimSlashes(b)},b.prototype._getHashFragment=function(){var b=a.location.hash.substr(1).replace(/(\?.*)$/,"");return this._trimSlashes(b)},b.prototype._getFragment=function(){return"history"===this.mode?this._getHistoryFragment():this._getHashFragment()},b.prototype._trimSlashes=function(a){return"string"!=typeof a?"":a.toString().replace(/\/$/,"").replace(/^\//,"")},b.prototype._page404=function(a){this.notFoundHandler(a)},b.prototype._parseRouteRule=function(a){if("string"!=typeof a)return a;var b=this._trimSlashes(a),c=b.replace(/([\\\/\-\_\.])/g,"\\$1").replace(/\{[a-zA-Z]+\}/g,"(:any)").replace(/\:any/g,"[\\w\\-\\_\\.]+").replace(/\:word/g,"[a-zA-Z]+").replace(/\:num/g,"d+");return new RegExp("^"+c+"$","i")},b.prototype._parseQuery=function(a){var b={};return"string"!=typeof a?b:("?"===a[0]&&(a=a.substr(1)),a.split("&").forEach(function(a){var c=a.split("=");""!==c[0]&&(void 0===c[1]&&(c[1]=!0),b[decodeURIComponent(c[0])]=c[1])}),b)},b.prototype._getHistoryQuery=function(){return this._parseQuery(a.location.search)},b.prototype._getHashQuery=function(){var b=a.location.hash.indexOf("?"),c=-1!==b?a.location.hash.substr(b):"";return this._parseQuery(c)},b.prototype._getQuery=function(){return"history"===this.mode?this._getHistoryQuery():this._getHashQuery()},b.prototype.add=function(a,b){return this.routes.push({rule:this._parseRouteRule(a),handler:b}),this},b.prototype.remove=function(a){var b=this;return"string"==typeof a&&(a=this._parseRouteRule(a).toString()),this.routes.some(function(c,d){return c.handler===a||c.rule.toString()===a?(b.routes.splice(d,1),!0):!1}),this},b.prototype.reset=function(){return this.routes=[],this.mode=null,this.root="/",this._pageState={},this.removeUriListener(),this},b.prototype.check=function(){var c=this,d=this._getFragment();"hash"===c.mode&&("add"===c._historyState&&(this._historyIdx!==this._historyStack.length-1&&this._historyStack.splice(this._historyIdx+1),this._historyStack.push({path:d,state:c._pageState}),this._historyIdx=this._historyStack.length-1),c._historyState="add");var e=this.routes.some(function(a){var e=d.match(a.rule);if(e){e.shift();var f=c._getQuery(),g=new b.Page(d,f,e,c._pageState);return a.handler.apply(g,e),c._pageState=null,!0}return!1});return e||(c._current=btoa(a.location.href),this._page404(d)),this},b.prototype.addUriListener=function(){var b=this;return"history"===b.mode?a.onpopstate=function(){b.check()}:a.onhashchange=function(){b.check()},this},b.prototype.removeUriListener=function(){return a.onpopstate=null,a.onhashchange=null,this},b.prototype.navigateTo=function(b,c){return b=this._trimSlashes(b)||"",this._pageState=c||null,"history"===this.mode?(history.pushState(c,null,this.root+this._trimSlashes(b)),this.check()):(a.location.hash=b,this)},b.prototype.back=function(){return"history"===this.mode?(a.history.back(),this):this.go(this._historyIdx-1)},b.prototype.forward=function(){return"history"===this.mode?(a.history.forward(),this):this.go(this._historyIdx+1)},b.prototype.go=function(b){if("history"===this.mode)return a.history.go(b),this;var c=this._historyStack[b];return c?(this._historyIdx=b,this._historyState="hold",this.navigateTo(c.path,c.state)):this},a.Router=b}(window);