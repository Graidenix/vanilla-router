!function(t){"use strict";function e(e){var r=this._getSettings(e);return this.routes=r.routes,this.notFoundHandler=r.page404,this.mode=t.history&&t.history.pushState?r.mode:"hash",this.root="/"===r.root?"/":"/"+this._trimSlashes(r.root)+"/",this._pageState=null,this.beforeHook=r.hooks.before,this._currentPage=null,this._skipCheck=!1,"hash"===this.mode&&(this._historyStack=[],this._historyIdx=0,this._historyState="add"),this}e.Page=function(t,e,r,o,s){this.uri=t||"",this.query=e||{},this.params=r||[],this.state=o||null,this.options=s||{}},e.prototype._getSettings=function(t){var e={},r={routes:[],mode:"history",root:"/",hooks:{before:function(){}},page404:function(t){console.error({page:t,message:"404. Page not found"})}};return t=t||{},["routes","mode","root","page404","hooks"].forEach(function(o){e[o]=t[o]||r[o]}),e},e.prototype._getHistoryFragment=function(){var e=decodeURI(t.location.pathname);return"/"!==this.root&&(e=e.replace(this.root,"")),this._trimSlashes(e)},e.prototype._getHashFragment=function(){var e=t.location.hash.substr(1).replace(/(\?.*)$/,"");return this._trimSlashes(e)},e.prototype._getFragment=function(){return"history"===this.mode?this._getHistoryFragment():this._getHashFragment()},e.prototype._trimSlashes=function(t){return"string"!=typeof t?"":(""+t).replace(/\/$/,"").replace(/^\//,"")},e.prototype._page404=function(t){this.notFoundHandler(t)},e.prototype._parseRouteRule=function(t){if("string"!=typeof t)return t;var e=this._trimSlashes(t),r=e.replace(/([\\\/\-\_\.])/g,"\\$1").replace(/\{[a-zA-Z]+\}/g,"(:any)").replace(/\:any/g,"[\\w\\-\\_\\.]+").replace(/\:word/g,"[a-zA-Z]+").replace(/\:num/g,"\\d+");return RegExp("^"+r+"$","i")},e.prototype._parseQuery=function(t){var e={};return"string"!=typeof t?e:("?"===t[0]&&(t=t.substr(1)),this._queryString=t,t.split("&").forEach(function(t){var r=t.split("=");""!==r[0]&&(void 0===r[1]&&(r[1]=!0),e[decodeURIComponent(r[0])]=r[1])}),e)},e.prototype._getHistoryQuery=function(){return this._parseQuery(t.location.search)},e.prototype._getHashQuery=function(){var e=t.location.hash.indexOf("?"),r=-1!==e?t.location.hash.substr(e):"";return this._parseQuery(r)},e.prototype._getQuery=function(){return"history"===this.mode?this._getHistoryQuery():this._getHashQuery()},e.prototype.add=function(t,e,r){return this.routes.push({rule:this._parseRouteRule(t),handler:e,options:r}),this},e.prototype.remove=function(t){var e=this;return"string"==typeof t&&(t=""+this._parseRouteRule(t)),this.routes.some(function(r,o){return r.handler===t||""+r.rule===t?(e.routes.splice(o,1),!0):!1}),this},e.prototype.reset=function(){return this.routes=[],this.mode=null,this.root="/",this._pageState={},this.removeUriListener(),this},e.prototype._pushHistory=function(){var t=this,e=this._getFragment();"hash"===this.mode&&("add"===this._historyState&&(this._historyIdx!==this._historyStack.length-1&&this._historyStack.splice(this._historyIdx+1),this._historyStack.push({path:e,state:t._pageState}),this._historyIdx=this._historyStack.length-1),this._historyState="add")},e.prototype.check=function(){var t=this,r=this._getFragment();this._pushHistory();var o=this.routes.some(function(o){var s=r.match(o.rule);if(s){s.shift();var i=t._getQuery(),h=new e.Page(r,i,s,t._pageState,o.options);return t._currentPage=h,t._skipCheck?(t._skipCheck=!1,!0):(t.beforeHook(h),o.handler.apply(h,s),t._pageState=null,!0)}return!1});return o||this._page404(r),this},e.prototype.addUriListener=function(){var e=this;return"history"===e.mode?t.onpopstate=function(){return e.check()}:t.onhashchange=function(){return e.check()},this},e.prototype.removeUriListener=function(){return t.onpopstate=null,t.onhashchange=null,this},e.prototype.navigateTo=function(e,r,o){return e=this._trimSlashes(e)||"",this._pageState=r||null,this._skipCheck=!!o,"history"===this.mode?(history.pushState(r,null,this.root+this._trimSlashes(e)),this.check()):(t.location.hash=e,this)},e.prototype.refresh=function(){var t=this._currentPage.uri+"?"+this._queryString;return this.navigateTo(t,this._currentPage.state)},e.prototype.back=function(){return"history"===this.mode?(t.history.back(),this):this.go(this._historyIdx-1)},e.prototype.forward=function(){return"history"===this.mode?(t.history.forward(),this):this.go(this._historyIdx+1)},e.prototype.go=function(e){if("history"===this.mode)return t.history.go(e),this;var r=this._historyStack[e];return r?(this._historyIdx=e,this._historyState="hold",this.navigateTo(r.path,r.state)):this},t.Router=e}(window);